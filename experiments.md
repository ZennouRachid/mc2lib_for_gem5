# Experiments Running McVersi over gem5

We use an Ubuntu Virtual machine set as follows:

* Memory : 4096MB

* Processor : Intel® Core™ i5-5200U CPU @ 2.20GHz × 4

* Hard disk : 250 GB

* OS : Ubuntu 18.04.1 LTS 64-bit

* g++ version 4.8

## gem5 setup

- We downloaded the gem5 sources (changeset 11520) pointed to from the [McVersi webpage](https://www.marcoelver.com/research/mcversi/).

- We applied the ```mcversi_gem5.patch``` patch.

- We set up the system parameters (see below) following the paper's instructions.

- After appling the patch, we failed when trying to initialize the full systsem simulation. Thus we moved the ```mcversi.*``` files generated by the patch from the `gem5` folder to ```gem5/src/sim``` as the initialization of gem5 was not finding those files. We also copied ```mc2lib/mc2lib``` directory to the ```gem5/src/sim``` directory for the same reasons. This fix solved the reported "file not found" errors.

### Configuration Parameters

We set up the system's parameters according to Table 2 in the paper:

 - _ROB entries_: We modified the default value of ROBEntries in ```src/cpu/o3/O3CPU.py```. The default value is 192; we modify it to 40.
 
 ```ROB entries = 40``` 
 
 - _LSQ entries_: We modified the default value of LQEntries and SQEntries in ```src/cpu/o3/O3CPU.py```. Since gem5 has a separate queue for loads and stores, we set each variable to 16 so that the aggregated size becomes 32.
 
```LSQ entries = 32```
 
 - _L1 and L2 hit latency_: We modified the default value of hit_latency in the L1Cache class and L2Cache class in ```configs/common/Caches.py```. We set L1 hit latency to 3 and L2 hit latency to 30.
  
 - _Memory hit latency_: **We did not find where to set up the Memory latency parameters, so we assume we are running with the default values for these parameters.**

## Starting up the X86 full system simulation

We start the full system simulation with the following arguments:

```console
rachid@ubuntu:~/gem5$ ./build/X86/gem5.opt configs/example/fs.py --disk-image=/home/rachid/gem5/full_system_images/disks/linux-x86.img --kernel=/home/rachid/gem5/full_system_images/binaries/x86_64-vmlinux-2.6.22.9.smp --mem-size=512MB --cpu-type=detailed --cpu-clock=2GHz --ruby --num-cpus=4 --l1d_size=32kB --l1i_size=32kB --cacheline_size=64 --l1i_assoc=4 --l1d_assoc=4 --num-l2caches=8 --l2_size=128kB --l2_assoc=4  --topology=Mesh --mesh-rows=2 --num-dirs=8 --garnet-network=fixed 

```

The console Output was:

```console
gem5 Simulator System.  http://gem5.org

gem5 is copyrighted software; use the --copyright option for details.

gem5 compiled Nov 30 2018 02:16:46

gem5 started Dec  5 2018 00:57:58

gem5 executing on ubuntu, pid 27508

command line: ./build/X86/gem5.opt configs/example/fs.py --disk-image=/home/rachid/gem5/full_system_images/disks/linux-x86.img --kernel=/home/rachid/gem5/full_system_images/binaries/x86_64-vmlinux-2.6.22.9.smp --mem-size=512MB --cpu-type=detailed --cpu-clock=2GHz --ruby --num-cpus=4 --l1d_size=32kB --l1i_size=32kB --cacheline_size=64 --l1i_assoc=4 --l1d_assoc=4 --num-l2caches=8 --l2_size=128kB --l2_assoc=4 --topology=Mesh --mesh-rows=2 --num-dirs=16 --garnet-network=fixed

warn: add_child('cls'): child 'credit_links0 credit_links1' already has parent

warn: add_child('cls'): child 'credit_links0 credit_links1' already has parent

warn: add_child('cls'): child 'credit_links0 credit_links1' already has parent

warn: add_child('cls'): child 'credit_links0 credit_links1' already has parent

warn: add_child('cls'): child 'credit_links0 credit_links1' already has parent

warn: add_child('cls'): child 'credit_links0 credit_links1' already has parent

Global frequency set at 1000000000000 ticks per second

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (32 Mbytes)

info: kernel located at: /home/rachid/gem5/full_system_images/binaries/x86_64-vmlinux-2.6.22.9.smp

Listening for com_1 connection on port 3456

   0: rtc: Real-time clock set to Sun Jan  1 00:00:00 2012
      
0: system.remote_gdb.listener: listening for remote gdb #0 on port 7000

0: system.remote_gdb.listener: listening for remote gdb #1 on port 7001

0: system.remote_gdb.listener: listening for remote gdb #2 on port 7002

0: system.remote_gdb.listener: listening for remote gdb #3 on port 7003

warn: Reading current count from inactive timer.

**** REAL SIMULATION ****

info: Entering event queue @ 0.  Starting simulation...

warn: Replacement policy updates recently became the responsibility of SLICC state machines. Make sure to setMRU() near callbacks in .sm files!

warn: Don't know what interrupt to clear for console.

5477138000: system.pc.com_1.terminal: attach terminal 0

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8082

warn: instruction 'wbinvd' unimplemented

warn: Address 0x100000000 is outside of physical memory, stopping fetch

warn: Address 0x100000000 is outside of physical memory, stopping fetch

warn: instruction 'wbinvd' unimplemented

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: Address 0x100000000 is outside of physical memory, stopping fetch

warn: Address 0x100000000 is outside of physical memory, stopping fetch

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: Address 0x100000000 is outside of physical memory, stopping fetch

warn: Address 0x100000000 is outside of physical memory, stopping fetch

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

warn: x86 cpuid: unknown family 0x8086

hack: Assuming logical destinations are 1 << id.
```

We seem to have succeded, as there are no errors reported.

## Experiments

### Hello world! under X86 full system:

In order to test the X86 full system setup, we run a hello world script from the test suit ```(gem5/tests/test-progs/hello/bin/x86/linux/hello)```:

```(console)
(none) movefile # ./hello
./hello
```
We succesfully got,

```Hello world!```

## Running Mcversi's Guest Workload under X86 full system:

We then tried to run MecVersi's guest workload, following the instructions from [McVersi's github](https://github.com/melver/mc2lib/blob/master/contrib/mcversi/run-10-8KB.sh). We used the pre-compiled system workload.

### Using 4 threads:

```(console)
(none) movefile # ./guest_workload.x86-64 4 0xf00200 0x09140010 0x100000000

./guest_workload.x86-64 4 0xf00200 0x09140010 0x100000000
```
However, this gets us the following segmentation fault error,

```
Threads: 4

Test iterations: 15729152

Test memory: 152305680 bytes (stride=0x100000000) @ 0x2b41eb3e9010

Spawning threads ...

Running tests ...

guest_workload.[833]: segfault at 0000000000000000 rip 00002aaaaaabb000 rsp 00000000410010e8 error 4

guest_workload.[832]: segfault at 0000000000000000 rip 00002aaaaaaab000 rsp 00000000408000e8 error 4

guest_workload.[831]: segfault at 0000000000000000 rip 00002aaaaaadb000 rsp 00007fffbfe38268 error 4

guest_workload.[834]: segfault at 0000000000000000 rip 00002aaaaaacb000 rsp 00000000418020e8 error 4

Segmentation fault
```

### Using 10 threads

We also tried using 10 threads, again with no luck.

```(console)
(none) movefile # ./guest_workload.x86-64 10 0xf00200 0x09140010 0x100000000

./guest_workload.x86-64 10 0xf00200 0x09140010 0x100000000
```

```
Threads: 10 

Test iterations: 15729152

Test memory: 152305680 bytes (stride=0x100000000) @ 0x2ae62f8f8010

Spawning threads ...

guest_workload.x86-64: guest_workload.c:223: spawn_threads: Assertion `!rc' failed.

Aborted
```
